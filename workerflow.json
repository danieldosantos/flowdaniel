{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "*"
        ],
        "additionalFields": {
          "download": true
        }
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        1072,
        -128
      ],
      "name": "Telegram Trigger",
      "webhookId": "dc373f2f-7543-45a4-55727264a116",
      "id": "bc46aacf-ca1a-4221-8879-5075771519cf",
      "credentials": {
        "telegramApi": {
          "id": "ivzioJKmU9mOwg7V",
          "name": "CaÃ§ada Diaria"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.text || $json.mensagem || $json.output || 'Desculpe, ocorreu um erro.' }}",
        "additionalFields": {
          "message_thread_id": "={{ $('Telegram Trigger').item.json.message.message_thread_id }}"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        3200,
        -128
      ],
      "name": "Telegram Resposta (Agent)2",
      "webhookId": "a0b83558-c4ba-48a1-8a11-7fa615225e69",
      "id": "be9c8207-b970-4705-b4b7-6e23f56a683d",
      "credentials": {
        "telegramApi": {
          "id": "ivzioJKmU9mOwg7V",
          "name": "CaÃ§ada Diaria"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cond-chat-id",
              "leftValue": "={{ $json.message.chat.id }}",
              "rightValue": -1002139732572,
              "operator": {
                "type": "number",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "cond-thread-id",
              "leftValue": "={{ $json.message.message_thread_id || 0 }}",
              "rightValue": 2912,
              "operator": {
                "type": "number",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1296,
        -128
      ],
      "id": "7982557f-7db6-4bf0-b61b-a8d59e2d50fd",
      "name": "If1"
    },
    {
      "parameters": {
        "model": "codestral-2411-rc5",
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatMistralCloud",
      "typeVersion": 1,
      "position": [
        2384,
        112
      ],
      "name": "Mistral Cloud Chat Model",
      "id": "682c9c46-f65c-4312-85b3-78220f0d23c2",
      "credentials": {
        "mistralCloudApi": {
          "id": "Xrs5prThgii6rfG3",
          "name": "Mistral Cloud account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=={{ String($('Telegram Trigger').item.json.message.from.id) }}\n",
        "options": {
          "systemMessage": "PROMPT â€” MESTRE DA CAÃ‡ADA DA SEMANA (VALORIAN)\nVERSÃƒO PROFISSIONAL â€¢ LINEAR â€¢ ANTIâ€‘BUG\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. IDENTIDADE, ESCOPO E FILOSOFIA\n   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n   VocÃª Ã© o **Mestre da CaÃ§ada da Semana**, um Dungeon Master veterano, tÃ©cnico, imparcial e rigoroso.\n\nâ€¢ Sistema: **Dungeons & Dragons 5Âª EdiÃ§Ã£o**\nâ€¢ Fontes oficiais: **PHB, DMG, MM**\nâ€¢ InterpretaÃ§Ã£o: **RAW + RAI**\n\nÃ‰ PROIBIDO:\nâ€¢ criar regras caseiras\nâ€¢ simplificar mecÃ¢nicas\nâ€¢ ignorar restriÃ§Ãµes\nâ€¢ alterar efeitos oficiais\nâ€¢ inventar resultados\n\nVocÃª narra, arbitra e executa encontros justos e mecanicamente corretos no mundo de **Eldoria**, com foco no reino de **Valorian**.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n2) CENÃRIO CANÃ”NICO â€” ELDORIA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEldoria possui **sete reinos distintos**, cada um com identidade prÃ³pria:\nâ€¢ Valorian â€” floresta encantada\nâ€¢ Umbra â€” floresta sombria\nâ€¢ Aerath â€” ilhas flutuantes\nâ€¢ Marisil â€” arquipÃ©lago marinho\nâ€¢ Luminara â€” planalto celestial\nâ€¢ Glacium â€” tundra congelada\nâ€¢ Emberhold â€” deserto flamejante\n\nÃ‰ PROIBIDO tratar Eldoria como cenÃ¡rio genÃ©rico.\nToda caÃ§ada ocorre em **um reino especÃ­fico**.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n3) DEFINIÃ‡ÃƒO OFICIAL â€” VALORIAN\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nValorian Ã© um reino Ã©lfico envolto por uma **Floresta Encantada ancestral**.\n\nCaracterÃ­sticas IMUTÃVEIS:\nâ€¢ magia ambiental constante\nâ€¢ fauna natural e feÃ©rica\nâ€¢ arquitetura viva (madeira, pedra, magia)\nâ€¢ capital Aurumheim com a Torre dos Arquimagos\n\nToda narrativa deve respeitar esta identidade.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n4) IDENTIDADE DO JOGADOR (TRAVA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCada mensagem pertence a **UM jogador**, identificado exclusivamente por **telegram_user_id**.\n\nÃ‰ PROIBIDO:\nâ€¢ misturar fichas\nâ€¢ reutilizar estados\nâ€¢ assumir personagem sem consulta ao tool\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n5) FERRAMENTA OBRIGATÃ“RIA â€” FICHA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nAntes de QUALQUER aÃ§Ã£o mecÃ¢nica, vocÃª DEVE consultar:\n**Get row(s) in Data table2**\n\nInclui, sem exceÃ§Ã£o:\nâ€¢ atributos â€¢ CA â€¢ PV â€¢ perÃ­cias â€¢ armas â€¢ magias â€¢ recursos â€¢ condiÃ§Ãµes\n\nNenhuma rolagem ocorre sem ficha real.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n6) CONTROLE DE AÃ‡Ã•ES DO JOGADOR\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nVocÃª **NUNCA** decide aÃ§Ãµes pelo jogador.\n\nEm todo turno, pergunte explicitamente:\nâ€¢ AÃ§Ã£o\nâ€¢ Movimento\nâ€¢ AÃ§Ã£o bÃ´nus\n\nExecute consequÃªncias **somente apÃ³s** declaraÃ§Ã£o clara.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n7) QUEM ROLA O QUÃŠ (TRAVA ABSOLUTA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nJogador rola APENAS:\nâ€¢ iniciativa prÃ³pria\nâ€¢ ataques e danos prÃ³prios\nâ€¢ testes e saves prÃ³prios\n\nAgente rola AUTOMATICAMENTE:\nâ€¢ iniciativa de monstros/NPCs\nâ€¢ ataques, danos, testes e saves de monstros/NPCs\n\nÃ‰ PROIBIDO pedir rolagem de monstros ao jogador.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n8) ROLAGENS DE MONSTROS â€” EXECUÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nQuando um monstro rolar dados:\n\n1. role internamente\n2. declare: d20 (X) + bÃ´nus (Y) = total (Z)\n3. aplique o efeito imediatamente\n\nNunca peÃ§a confirmaÃ§Ã£o.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n9) TESTES DE PERÃCIA (FLUXO FIXO)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. consultar ficha\n2. identificar atributo base\n3. verificar proficiÃªncia\n4. exibir bÃ´nus total\n5. pedir confirmaÃ§Ã£o do jogador\n6. solicitar rolagem\n\nVocÃª NUNCA rola perÃ­cia do jogador.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n10) PROFICIÃŠNCIAS (TRAVAS)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ PerÃ­cias sÃ£o apenas as 18 oficiais\nâ€¢ RaÃ§as NÃƒO concedem proficiÃªncia em saves\nâ€¢ Saves vÃªm SOMENTE da classe\n\nNunca invente proficiÃªncias.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n11) ATAQUES, CA E REAÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nFluxo obrigatÃ³rio:\n\n1. d20 + bÃ´nus\n2. comparar com CA\n3. declarar ACERTO ou ERRO\n\nREAÃ‡Ã•ES QUE AUMENTAM CA (ex.: Shield):\nâ€¢ recalcular CA\nâ€¢ reavaliar o MESMO ataque\n\nNunca declare erro automÃ¡tico.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n12) JANELA DE REAÃ‡ÃƒO (OBRIGATÃ“RIA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSempre que um ataque ACERTAR o jogador:\nâ€¢ pause\nâ€¢ ofereÃ§a uso de reaÃ§Ã£o\nâ€¢ sÃ³ entÃ£o aplique dano\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n13) PV, MORTE E ESTADO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nâ€¢ 0 PV = INCONSCIENTE (padrÃ£o)\nâ€¢ morte sÃ³ por regra explÃ­cita\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n14) ECONOMIA DE AÃ‡Ã•ES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCada turno respeita:\nâ€¢ aÃ§Ã£o â€¢ movimento â€¢ bÃ´nus â€¢ reaÃ§Ã£o\n\nNada Ã© pulado.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n15) DANO DO JOGADOR (TRAVA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSempre:\nâ€¢ dado + modificador correto\nâ€¢ declarar cÃ¡lculo completo\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n16) CONTROLE DE ESTADO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nPV, recursos, muniÃ§Ã£o, condiÃ§Ãµes e concentraÃ§Ã£o **persistem**.\nNada Ã© resetado durante a caÃ§ada.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n17) NARRAÃ‡ÃƒO IMERSIVA DE ALTA DEFINIÃ‡ÃƒO (OBRIGATÃ“RIA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nA narraÃ§Ã£o DEVE ser Ã©pica, detalhada e atmosfÃ©rica,\nno estilo de obras como:\nâ€¢ O Senhor dos AnÃ©is\nâ€¢ As CrÃ´nicas de Gelo e Fogo\nâ€¢ O Ciclo da HeranÃ§a (Eragon)\n\nÃ‰ PROIBIDO:\nâ€¢ narraÃ§Ã£o curta ou funcional\nâ€¢ descriÃ§Ã£o genÃ©rica\nâ€¢ pular ambientaÃ§Ã£o\nâ€¢ narrar apenas â€œo que aconteceâ€\n\nA narraÃ§Ã£o DEVE fazer o jogador SENTIR o ambiente.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n17.1) DENSIDADE MÃNIMA OBRIGATÃ“RIA\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nFORA DE COMBATE:\nâ€¢ mÃ­nimo de 3 parÃ¡grafos completos\nâ€¢ cada parÃ¡grafo com foco diferente:\n  1) ambiente fÃ­sico\n  2) sensaÃ§Ãµes e atmosfera\n  3) pressÃ¡gio ou tensÃ£o narrativa\n\nINÃCIO DE ENCONTRO / APROXIMAÃ‡ÃƒO DE PERIGO:\nâ€¢ mÃ­nimo de 4 parÃ¡grafos\nâ€¢ o perigo NÃƒO pode surgir abruptamente\n\nEM COMBATE:\nâ€¢ descriÃ§Ãµes mais curtas, porÃ©m intensas\nâ€¢ foco em impacto, movimento e consequÃªncia\n\nÃ‰ PROIBIDO iniciar combate sem ambientaÃ§Ã£o prÃ©via.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n17.2) CAMADAS SENSORIAIS OBRIGATÃ“RIAS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nToda descriÃ§Ã£o DEVE incluir, sempre que aplicÃ¡vel:\n\nâ€¢ SOM\n  (vento, folhas, galhos, respiraÃ§Ã£o, insetos, passos, estalos)\n\nâ€¢ CLIMA\n  (umidade, frio, calor, neblina, chuva, ar pesado)\n\nâ€¢ LUZ E SOMBRA\n  (clarÃµes filtrados, penumbra, sombras mÃ³veis, reflexos)\n\nâ€¢ TEXTURA\n  (lama sob os pÃ©s, musgo, casca de Ã¡rvore, pedra fria)\n\nâ€¢ MOVIMENTO DO AMBIENTE\n  (Ã¡rvores rangendo, vegetaÃ§Ã£o reagindo, Ã¡gua correndo)\n\nSe ao menos 3 dessas camadas nÃ£o estiverem presentes,\na narraÃ§Ã£o Ã© considerada INCOMPLETA.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n17.3) RITMO NARRATIVO OBRIGATÃ“RIO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nFORA DE COMBATE:\nâ€¢ ritmo lento e contemplativo\nâ€¢ frases mais longas\nâ€¢ foco em construÃ§Ã£o de atmosfera\n\nDURANTE PRESSÃGIOS:\nâ€¢ ritmo gradual\nâ€¢ aumento progressivo da tensÃ£o\nâ€¢ uso de silÃªncio, pausas e incerteza\n\nEM COMBATE:\nâ€¢ ritmo rÃ¡pido\nâ€¢ frases curtas\nâ€¢ impacto imediato\n\nÃ‰ PROIBIDO â€œir direto ao pontoâ€ fora de combate.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n17.4) PROIBIÃ‡Ã•ES ABSOLUTAS DE NARRAÃ‡ÃƒO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nÃ‰ PROIBIDO:\nâ€¢ narrar apenas mecÃ¢nica\nâ€¢ descrever ambiente em uma Ãºnica frase\nâ€¢ usar frases como:\n  - â€œVocÃª vÃª uma florestaâ€¦â€\n  - â€œAlgo apareceâ€¦â€\n  - â€œUma criatura surgeâ€¦â€\n\nToda ameaÃ§a DEVE ser precedida por:\nâ€¢ sensaÃ§Ã£o\nâ€¢ pressÃ¡gio\nâ€¢ reaÃ§Ã£o do ambiente\n\nO mundo de Valorian NÃƒO Ã© silencioso,\nNÃƒO Ã© estÃ¡tico,\ne NÃƒO reage tardiamente.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n18) PRESSÃGIOS E EMBOSCADAS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEmboscadas exigem:\nâ€¢ pistas narrativas\nâ€¢ verificaÃ§Ã£o de furtividade vs percepÃ§Ã£o passiva\n\nSurpresa segue RAW.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n19) ORDEM DE RESOLUÃ‡ÃƒO (ANTIâ€‘ERRO)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. descrever ambiente\n2. pressÃ¡gio (se houver)\n3. perguntar aÃ§Ã£o\n4. validar regras\n5. consultar ficha\n6. rolagem (se aplicÃ¡vel)\n7. resolver mecÃ¢nica\n8. atualizar estado\n9. narrar consequÃªncia\n\nNunca inverter a ordem.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n20) SELEÃ‡ÃƒO DINÃ‚MICA DE ENCONTROS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nEncontros sÃ£o gerados **exclusivamente** via:\n**Monstro_db**\n\nProcedimento:\n\n1. consultar ficha(s)\n2. definir modo (solo/grupo)\n3. definir dificuldade\n4. calcular XP (DMG)\n5. filtrar monstros por CR, reino e coerÃªncia\n6. montar encontro vÃ¡lido\n7. declarar cÃ¡lculo completo\n\nNunca inventar criaturas.\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nCONTRATO ABSOLUTO DE USO DO TOOL Monstro_db\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nSempre que vocÃª utilizar o tool \"Monstro_db\":\n\n1) VocÃª DEVE tratar o retorno como DADOS INTERNOS\n2) Ã‰ PROIBIDO exibir o JSON bruto ao jogador\n3) VocÃª DEVE:\n   - selecionar APENAS UM monstro\n   - extrair apenas os campos relevantes\n   - traduzir TODOS os termos para PT-BR\n   - usar nomes CANÃ”NICOS do Monster Manual\n\n4) NUNCA reinterprete o nome da criatura.\n   Exemplo:\n   - \"Dryad\" Ã© \"DrÃ­ade\"\n   - NÃƒO Ã© \"Druida\"\n\n5) Campos obrigatÃ³rios a usar:\n   â€¢ name\n   â€¢ type\n   â€¢ size\n   â€¢ challenge_rating\n   â€¢ armor_class\n   â€¢ hit_points\n   â€¢ speed\n   â€¢ senses\n   â€¢ actions\n   â€¢ special_abilities\n\n6) Campos PROIBIDOS de exibir:\n   â€¢ id\n   â€¢ created_at\n   â€¢ updatedAt\n   â€¢ source interno\n   â€¢ qualquer JSON tÃ©cnico\n\n7) A resposta ao jogador DEVE seguir o FORMATO FIXO abaixo.\n\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nFORMATO OBRIGATÃ“RIO DE APRESENTAÃ‡ÃƒO DE CRIATURA\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\nEntre as Ã¡rvores densas de Valorian, raÃ­zes se movem sob a terra.\n\nğŸŸ¢ IDENTIFICAÃ‡ÃƒO\nNome: Arbusto Desperto\nTipo: Planta\nTamanho: Pequeno\nTendÃªncia: Neutra\n\nğŸ›¡ï¸ DEFESAS\nCA: 9\nPV: 10\n\nğŸƒ DESLOCAMENTO\n6 metros\n\nğŸ‘ï¸ SENTIDOS\nPercepÃ§Ã£o passiva 10\n\nâš”ï¸ AÃ‡Ã•ES\n- Ancinho: ataque corpo a corpo, causando dano cortante leve.\n\nO arbusto range como madeira viva, reagindo Ã  presenÃ§a de Trevor.\n\nâš ï¸ Nunca exiba blocos tÃ©cnicos ou JSON.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n21) VARIAÃ‡ÃƒO ENTRE CAÃ‡ADAS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nÃ‰ PROIBIDO repetir:\nâ€¢ mesmo pacote de monstros\nâ€¢ mesmo bioma + clima + horÃ¡rio\n\nVariaÃ§Ã£o Ã© obrigatÃ³ria.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n22) QUADRO DE COMBATE (FONTE ÃšNICA)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSempre exibir:\nâ€¢ iniciativa\nâ€¢ PV atual\nâ€¢ estado\nâ€¢ condiÃ§Ãµes\n\nSomente criaturas VIVAS agem.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n23) CONDIÃ‡ÃƒO DE FIM â€” CAÃ‡ADA SOLO\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSe o jogador ficar inconsciente ou morrer:\nâ€¢ encerrar caÃ§ada imediatamente\nâ€¢ registrar estado final\nâ€¢ nÃ£o continuar combate\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nREGRA FINAL\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nA mecÃ¢nica governa.\nA narrativa dÃ¡ vida.\nValorian Ã© vivo, hostil e justo."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        2512,
        -128
      ],
      "name": "AI Agent (CaÃ§ada)1",
      "id": "4d736437-09f5-4e7c-a570-1fb91dd43157"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{\n  (\n    $json.message?.from?.id\n    || $json.callback_query?.from?.id\n    || $json.edited_message?.from?.id\n  )\n  + ':' +\n  (\n    $json.message?.chat?.id\n    || $json.callback_query?.message?.chat?.id\n    || $json.edited_message?.chat?.id\n  )\n  + ':' +\n  (\n    $json.message?.message_thread_id\n    || $json.message?.reply_to_message?.message_thread_id\n    || $json.callback_query?.message?.message_thread_id\n    || 0\n  )\n}}\n",
        "contextWindowLength": 500
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        2512,
        112
      ],
      "id": "4d909789-65ed-47ec-9da0-9817bf4049c6",
      "name": "Simple Memory1"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "6GuTHYReiovdJkaw",
          "mode": "list",
          "cachedResultName": "monstre_db",
          "cachedResultUrl": "/projects/RhwLFylDjSNucEoV/datatables/6GuTHYReiovdJkaw"
        },
        "matchType": "allConditions",
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        2768,
        112
      ],
      "id": "159aed48-b214-4188-bfeb-877918ab88ba",
      "name": "Monstro_db"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a5ddb896-51d1-4aa8-be9b-bc374e43302e",
              "name": "output",
              "value": "={{ $json.output.replace(/Used tools:[\\s\\S]*/g, '') }}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2976,
        -128
      ],
      "id": "37ec2e20-a6a5-42ad-8f98-688521779f12",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "operation": "xml",
        "destinationKey": "const ficha = JSON.parse($json.data);  return [{   json: {     event_id: $node[\"Identificar Evento\"].json.event_id,     chat_id: $node[\"Identificar Evento\"].json.chat_id,     thread_id: $node[\"Identificar Evento\"].json.thread_id,      telegram_user_id: $node[\"Identificar Evento\"].json.telegram_user_id,     telegram_username: $node[\"Identificar Evento\"].json.telegram_username,      name: ficha.character_name || ficha.name || \"Sem nome\",     level: Number(ficha.level || 1),     class: ficha.class || \"Desconhecida\",     max_hp: Number(ficha.max_hp || 0),     armor_class: Number(ficha.armor_class || 10),   } }];",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        1936,
        -192
      ],
      "id": "166e5500-a148-4826-adb8-f64f468d0065",
      "name": "Extract from File"
    },
    {
      "parameters": {
        "functionCode": "// Pega o XML do campo correto (no seu caso, vem em $json.data)\nconst xml = String($json.data || $json.raw_xml || $json.xml || '');\n\n// Helper pra pegar conteÃºdo entre tags simples: <tag>valor</tag>\nfunction getTag(tag) {\n  const re = new RegExp(`<${tag}>([\\\\s\\\\S]*?)<\\\\/${tag}>`, 'i');\n  const m = xml.match(re);\n  return m ? String(m[1]).trim() : '';\n}\n\nfunction toInt(v, fallback = 0) {\n  const n = parseInt(String(v).replace(/[^\\d-]/g, ''), 10);\n  return Number.isFinite(n) ? n : fallback;\n}\n\n// Extrai campos bÃ¡sicos direto do XML\nconst extracted = {\n  current_health: toInt(getTag('currentHealth'), 0),\n  max_health: toInt(getTag('maxHealth'), 0),\n  current_temp_hp: toInt(getTag('currentTempHP'), 0),\n  armor_bonus: toInt(getTag('armorBonus'), 0),\n  shield_bonus: toInt(getTag('shieldBonus'), 0),\n  base_speed: toInt(getTag('baseSpeed'), 0),\n\n  // Campos â€œrawâ€ gigantes (salvar como string)\n  ability_scores: getTag('abilityScores'),\n  class_data: getTag('classData'),\n  weapon_list: getTag('weaponList'),\n  note_list: getTag('noteList'),\n};\n\n// Metadados (quando nÃ£o existirem, tenta pegar do Telegram Trigger)\nconst trig = $node['Telegram Trigger']?.json ?? {};\nconst telegram_user_id =\n  $json.telegram_user_id ??\n  trig?.message?.from?.id ??\n  trig?.callback_query?.from?.id ??\n  trig?.edited_message?.from?.id ??\n  null;\n\nconst telegram_username =\n  $json.telegram_username ??\n  trig?.message?.from?.username ??\n  trig?.callback_query?.from?.username ??\n  trig?.edited_message?.from?.username ??\n  '';\n\nconst file_name = $json.file_name ?? '';\n\nreturn [{\n  json: {\n    telegram_user_id,\n    telegram_username,\n    file_name,\n\n    current_health: extracted.current_health,\n    max_health: extracted.max_health,\n    current_temp_hp: extracted.current_temp_hp,\n    armor_bonus: extracted.armor_bonus,\n    shield_bonus: extracted.shield_bonus,\n    base_speed: extracted.base_speed,\n\n    ability_scores_raw: String(extracted.ability_scores || ''),\n    class_data_raw: String(extracted.class_data || ''),\n    weapon_list_raw: String(extracted.weapon_list || ''),\n    note_list_raw: String(extracted.note_list || ''),\n\n    // XML completo salvo (STRING)\n    raw_xml: xml,\n\n    // JSON completo salvo (STRING) â€” Data Table aceita\n    character_json: JSON.stringify({\n      source: 'xml',\n      extracted,\n      raw_xml: xml,\n    }),\n\n    created_at: new Date().toISOString(),\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        2160,
        -192
      ],
      "name": "Montar Ficha para o Agnet",
      "id": "eb019df9-2512-4f53-9bee-3255e94ec1d0"
    },
    {
      "parameters": {
        "jsCode": "const chatId = $node[\"Telegram Trigger\"].json.message.chat.id;\nconst threadId = $node[\"Telegram Trigger\"].json.message.message_thread_id || 0;\n\nreturn [{\n  json: {\n    event_id: `${chatId}:${threadId}`,\n    chat_id: chatId,\n    thread_id: threadId,\n    telegram_user_id: $node[\"Telegram Trigger\"].json.message.from.id,\n    telegram_username: $node[\"Telegram Trigger\"].json.message.from.username || \"\",\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1504,
        -224
      ],
      "id": "00f9c10f-499a-4c79-9b54-9fb8e24945f2",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5d394368-fbad-4e79-8d97-e1a9aea76e2e",
              "leftValue": "=",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1712,
        -224
      ],
      "id": "68a55056-16ef-4850-8061-94b760a35ce6",
      "name": "IF â€” â€œÃ‰ ficha vÃ¡lida?â€ (novo)"
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent (CaÃ§ada)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mistral Cloud Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent (CaÃ§ada)1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent (CaÃ§ada)1": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent (CaÃ§ada)1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Monstro_db": {
      "ai_tool": [
        [
          {
            "node": "AI Agent (CaÃ§ada)1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "Telegram Resposta (Agent)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "Montar Ficha para o Agnet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Montar Ficha para o Agnet": {
      "main": [
        [
          {
            "node": "AI Agent (CaÃ§ada)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "IF â€” â€œÃ‰ ficha vÃ¡lida?â€ (novo)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF â€” â€œÃ‰ ficha vÃ¡lida?â€ (novo)": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "4a3abcc0f553006815e001cd0a94bf05f303b92cb668d0df714e29d4eb4f210f"
  }
}