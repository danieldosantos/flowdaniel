{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "*"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -80,
        -16
      ],
      "name": "Telegram Trigger",
      "id": "97e299c2-fc35-4782-97dd-354c0dbb6251",
      "webhookId": "dc373f2f-7543-45c6-bd4a-55727264a116",
      "credentials": {
        "telegramApi": {
          "id": "1TgyA7zT6HSpXmrB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "chat_id",
              "value": "={{ $json[\"message\"][\"chat\"][\"id\"] }}"
            },
            {
              "name": "telegram_user_id",
              "value": "={{ $json[\"message\"][\"from\"][\"id\"] }}"
            },
            {
              "name": "telegram_username",
              "value": "={{ $json[\"message\"][\"from\"][\"username\"] || \"\" }}"
            },
            {
              "name": "message_text",
              "value": "={{ $json[\"message\"][\"text\"] || \"\" }}"
            },
            {
              "name": "message_id",
              "value": "={{ $json[\"message\"][\"message_id\"] }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3,
      "position": [
        160,
        -16
      ],
      "name": "Preparar Mensagem",
      "id": "f8a0a82e-187a-4a78-966f-c4a73ab2a815"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.message_text }}",
        "options": {
          "systemMessage": "Você é o AGENTE OFICIAL DE REGISTRO DE PERSONAGENS D&D 5e do grupo Mestre Galhart.\n\nOBJETIVO:\nColetar e registrar fichas D&D 5e perguntando UMA informação por vez.\n\nREFERÊNCIAS:\n- Utilize as listas internas de classes, raças, antecedentes, talentos e magias (bgs.json, classes.json, raca.json, talentos.json, listademagia.json) apenas como guia para validar nomes. Caso o jogador informe algo fora do padrão, peça confirmação ou uma opção equivalente.\n\nREGRAS DE CONVERSA:\n- Não faça listas de perguntas.\n- Não narre histórias, não roleplay, não use Markdown pesado.\n- Não mostre dados coletados antes do final.\n- Se o usuário mudar de assunto, responda apenas: \"Estamos registrando seu personagem. Vamos continuar?\".\n\nFLUXO OBRIGATÓRIO (pergunte nesta ordem, aguardando resposta a cada passo):\n1. Nome real.\n2. Nome do personagem.\n3. Raça.\n4. Classe.\n5. Nível.\n6. Background (antecedente).\n7. Tendência.\n8. Força.\n9. Destreza.\n10. Constituição.\n11. Inteligência.\n12. Sabedoria.\n13. Carisma.\n14. PV máximos.\n15. Classe de Armadura.\n16. Conjurador? (true/false).\n17. Atributo de conjuração (se aplicável).\n18. Informações extras para sheet_json (ou responda \"não\").\n\nREGRAS DA FERRAMENTA:\n- Não peça o telegram_user_id ou o username; eles já estão no contexto.\n- Envie todos os campos obrigatórios para a Postgres RPG Tool uma única vez ao final.\n- Não envie campos além dos permitidos.\n\nFINALIZAÇÃO:\nApós resposta de sucesso da ferramenta, envie:\n1) \"✅ Personagem [character_name] registrado com sucesso!\"\n2) Um único bloco de texto, sem Markdown, com o resumo exatamente neste formato:\nResumo da Ficha:\nNome real: [real_name]\nPersonagem: [character_name]\nRaça: [race]\nClasse: [class]\nNível: [level]\nBackground: [background]\nTendência: [alignment]\nAtributos:\nForça: [str_score]\nDestreza: [dex_score]\nConstituição: [con_score]\nInteligência: [int_score]\nSabedoria: [wis_score]\nCarisma: [cha_score]\nCombate:\nPV Máx: [max_hp]\nClasse de Armadura: [armor_class]\nConjuração:\nConjurador: [is_spellcaster]\nAtributo: [spellcasting_ability]\nInformações extras:\n[sheet_json]\n- Não adicione comentários ou explicações.\n- Não inicie nova conversa após o resumo."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        432,
        -16
      ],
      "name": "AI Agent",
      "id": "5a00d6b8-932d-40e0-b0f2-f0ae54f3304c"
    },
    {
      "parameters": {
        "sessionKey": "={{ ($json.telegram_user_id || $json.chat_id) + \"-telegram\" }}",
        "sessionTTL": 3600
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1,
      "position": [
        480,
        208
      ],
      "name": "Redis Chat Memory",
      "id": "6747e9a4-3d96-4de0-a50e-56e222ead4e2",
      "credentials": {
        "redis": {
          "id": "cvoLMMT8ZAPUYxld",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Ferramenta Postgres para salvar fichas de personagem D&D 5e na tabela public.rpg_players.\n\nRegras:\n- Permitido apenas INSERT com UPSERT (ON CONFLICT) e SELECT na tabela public.rpg_players.\n- Nunca use DELETE, DROP ou TRUNCATE.\n- Campos aceitos: telegram_user_id, telegram_username, real_name, character_name, race, class, level, background, alignment, max_hp, armor_class, str_score, dex_score, con_score, int_score, wis_score, cha_score, is_spellcaster, spellcasting_ability, sheet_json.\n- telegram_user_id deve ser a chave única do jogador (vindo diretamente do Telegram Trigger).",
        "operation": "executeQuery",
        "query": "INSERT INTO public.rpg_players (\n telegram_user_id,\n telegram_username,\n real_name,\n character_name,\n race,\n class,\n level,\n background,\n alignment,\n max_hp,\n armor_class,\n str_score,\n dex_score,\n con_score,\n int_score,\n wis_score,\n cha_score,\n is_spellcaster,\n spellcasting_ability,\n sheet_json\n) VALUES (\n {{ $json.telegram_user_id }},\n '{{ $json.telegram_username }}',\n '{{ $json.real_name }}',\n '{{ $json.character_name }}',\n '{{ $json.race }}',\n '{{ $json.class }}',\n {{ $json.level }},\n '{{ $json.background }}',\n '{{ $json.alignment }}',\n {{ $json.max_hp }},\n {{ $json.armor_class }},\n {{ $json.str_score }},\n {{ $json.dex_score }},\n {{ $json.con_score }},\n {{ $json.int_score }},\n {{ $json.wis_score }},\n {{ $json.cha_score }},\n {{ $json.is_spellcaster }},\n '{{ $json.spellcasting_ability }}',\n '{{ JSON.stringify($json.sheet_json) }}'::jsonb\n)\nON CONFLICT (telegram_user_id) DO UPDATE SET\n telegram_username = EXCLUDED.telegram_username,\n real_name = EXCLUDED.real_name,\n character_name = EXCLUDED.character_name,\n race = EXCLUDED.race,\n class = EXCLUDED.class,\n level = EXCLUDED.level,\n background = EXCLUDED.background,\n alignment = EXCLUDED.alignment,\n max_hp = EXCLUDED.max_hp,\n armor_class = EXCLUDED.armor_class,\n str_score = EXCLUDED.str_score,\n dex_score = EXCLUDED.dex_score,\n con_score = EXCLUDED.con_score,\n int_score = EXCLUDED.int_score,\n wis_score = EXCLUDED.wis_score,\n cha_score = EXCLUDED.cha_score,\n is_spellcaster = EXCLUDED.is_spellcaster,\n spellcasting_ability = EXCLUDED.spellcasting_ability,\n sheet_json = EXCLUDED.sheet_json\nRETURNING telegram_user_id;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgresTool",
      "typeVersion": 2.6,
      "position": [
        688,
        192
      ],
      "name": "Postgres RPG Tool",
      "id": "04d3d256-eb8a-444a-8661-80d9a4f07360",
      "credentials": {
        "postgres": {
          "id": "fRNavSYNEr8rrgnR",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger').item.json.message.chat.id }}",
        "text": "={{ $json.output.replace(/([*_])/g, '\\\\$1') }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        848,
        -16
      ],
      "name": "Telegram Send",
      "id": "837d0dfd-404c-482f-8c6e-62af85aff1c6",
      "webhookId": "c424f4de-14b3-4dc1-982f-bdc4b581e888",
      "credentials": {
        "telegramApi": {
          "id": "1TgyA7zT6HSpXmrB",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        304,
        192
      ],
      "id": "d408bcef-9846-48e0-af1a-79146f9e5933",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "dCRBGTpFX8DnKm5Y",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Preparar Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Mensagem": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Telegram Send",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Postgres RPG Tool": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "82a0b6c2033eb2e531b802dac7072de9d7090a7397ee4c924dced66f92352e3f"
  }
}